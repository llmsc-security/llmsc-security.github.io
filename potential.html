<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SecurityScan Hub - Scan Results</title>
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    window.mermaid = mermaid;
</script>
<style>
/* --- ORIGINAL STYLES --- */
:root {
  --bg: #0a0b14;
  --bg-soft: #13151f;
  --panel: #1a1d2e;
  --ink: #e6e8f5;
  --muted: #9ca3c9;
  --border: #2a2d42;
  --primary: #6366f1;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #3b82f6;
  --critical: #d946ef;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--ink); display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; overflow: hidden; }

/* SIDEBAR */
.sidebar { background: var(--panel); border-right: 1px solid var(--border); padding: 24px; display: flex; flex-direction: column; height: 100vh; z-index: 10; }
.logo { display: flex; align-items: center; gap: 10px; margin-bottom: 32px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
.logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary), #8b5cf6); border-radius: 8px; display: grid; place-items: center; font-size: 18px; }
.logo-text { font-size: 16px; font-weight: 700; }
.nav-section { margin-bottom: 24px; }
.nav-section h4 { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); margin-bottom: 12px; font-weight: 600; }
.nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; color: var(--muted); text-decoration: none; font-size: 14px; transition: all 0.2s; cursor: pointer; }
.nav-item:hover, .nav-item.active { background: var(--bg-soft); color: var(--ink); }

/* MAIN LAYOUT */
.main-content { display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: relative; }

/* HEADER */
.header-wrapper { flex-shrink: 0; padding: 32px 32px 0 32px; background: var(--bg); z-index: 5; }
.header { margin-bottom: 20px; }
.breadcrumb { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--muted); margin-bottom: 16px; }
.breadcrumb a { color: var(--primary); text-decoration: none; }
.title-section { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px; }
.title-left { display: flex; flex-direction: column; gap: 4px; }
.title-left h1 { font-size: 32px; display: flex; align-items: center; gap: 12px; margin: 0; }
.repo-label { color: var(--muted); font-family: monospace; font-size: 13px; background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 4px; display: inline-block; margin-top: 5px; border: 1px solid var(--border); }

.meta-info { display: flex; gap: 24px; flex-wrap: wrap; padding: 16px; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; font-size: 14px; }
.meta-item { display: flex; align-items: center; gap: 8px; }

/* TABS CONTROL */
.tabs-container {
    display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border);
}
.tab-btn {
    background: transparent; border: none; color: var(--muted);
    padding: 12px 20px; font-size: 14px; font-weight: 600; cursor: pointer;
    border-bottom: 3px solid transparent; transition: all 0.2s;
    display: flex; align-items: center; gap: 8px;
}
.tab-btn:hover { color: var(--ink); background: rgba(255,255,255,0.02); }
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: rgba(99, 102, 241, 0.05); }

/* CONTENT VIEWS */
.view-panel { 
    display: none; 
    flex-direction: column; 
    flex: 1; 
    min-height: 0; 
    width: 100%;
}
.view-panel.active { display: flex; }

.scrollable-area { 
    flex: 1; 
    overflow-y: auto; 
    padding: 0 32px 32px 32px; 
}

/* --- STATS & VULN TABLE STYLES --- */
.stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
.stat-card { background: var(--panel); border: 1px solid var(--border); padding: 24px; border-radius: 12px; text-align: center; }
.stat-num { font-size: 32px; font-weight: 800; margin-bottom: 4px; }
.stat-label { color: var(--muted); font-size: 14px; }

.table-container { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 40px; }
.table-header-control { padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
table { width: 100%; border-collapse: collapse; }
th { text-align: left; padding: 16px 24px; background: var(--bg-soft); color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 2; }
td { padding: 16px 24px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
tr.main-row { cursor: pointer; transition: background 0.2s; }
tr.main-row:hover { background: var(--bg-soft); }
tr.main-row.expanded { background: rgba(99, 102, 241, 0.05); border-left: 3px solid var(--primary); }
tr.detail-row { display: none; background: #13151f; }
tr.detail-row.visible { display: table-row; }
.detail-content { padding: 24px; animation: slideDown 0.3s ease; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

/* Severity Badges */
.severity { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; }
.severity.critical { background: rgba(217, 70, 239, 0.15); color: var(--critical); border: 1px solid var(--critical); }
.severity.high { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid var(--danger); }
.severity.medium { background: rgba(245, 158, 11, 0.15); color: var(--warning); border: 1px solid var(--warning); }
.severity.low { background: rgba(59, 130, 246, 0.15); color: var(--info); border: 1px solid var(--info); }
.severity.none { background: rgba(156, 163, 175, 0.15); color: var(--muted); border: 1px solid var(--muted); }
.badge.npm { background: rgba(203, 56, 55, 0.2); color: #cb3837; padding:2px 6px; border-radius:4px; font-size:11px; }
.badge.pypi { background: rgba(55, 117, 169, 0.2); color: #3775a9; padding:2px 6px; border-radius:4px; font-size:11px; }

/* Markdown & Detail Styles */
.detail-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 16px; }
.detail-box { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 16px; border: 1px solid rgba(255,255,255,0.05); }
.detail-links a { display: block; color: var(--primary); margin-bottom: 4px; font-size: 13px; text-decoration: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.md-content pre { background: #0d1117; padding: 10px; overflow-x: auto; border-radius: 4px; }
.chevron { transition: transform 0.3s; display: inline-block; }
.expanded .chevron { transform: rotate(180deg); }
.loading-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* --- VIDEO MODAL STYLES --- */
.video-modal {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 2000;
    justify-content: center; align-items: center;
    backdrop-filter: blur(5px);
    animation: fadeIn 0.2s ease;
}
.video-content {
    position: relative;
    width: 80%;
    max-width: 960px;
    background: #000;
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
    overflow: hidden;
    display: flex; flex-direction: column;
}
.video-header {
    padding: 12px 16px;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
}
.video-title { font-weight: 600; color: var(--ink); font-size: 14px; }
.close-video-btn {
    background: transparent; border: none;
    color: var(--muted); cursor: pointer;
    font-size: 20px; line-height: 1;
    padding: 4px; border-radius: 4px;
    transition: all 0.2s;
}
.close-video-btn:hover { color: var(--danger); background: rgba(239, 68, 68, 0.1); }

/* Unified Media Styles */
.media-viewport { width: 100%; height: 60vh; max-height: 70vh; background: black; display: flex; align-items: center; justify-content: center; }
video { width: 100%; height: 100%; display: none; }
iframe { width: 100%; height: 100%; border: none; display: none; }

/* The conditional button style */
.poc-btn {
    background: rgba(99, 102, 241, 0.1);
    border: 1px solid var(--primary);
    color: var(--primary);
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex; align-items: center; gap: 6px;
    margin-right: 10px;
}
.poc-btn:hover { background: var(--primary); color: white; transform: translateY(-1px); }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* --- ARCHITECTURE VIEW STYLES --- */
.arch-container { display: flex; height: 100%; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: #0d1117; }
.graph-pane { flex: 6; position: relative; border-right: 1px solid var(--border); overflow: hidden; cursor: grab; background: #0d1117; }
.graph-pane:active { cursor: grabbing; }
#zoom-layer { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; transform-origin: center center; transition: transform 0.1s ease-out; }
.details-pane { flex: 4; background: var(--panel); overflow-y: auto; padding: 0; min-width: 300px; border-left: 1px solid var(--border); display: flex; flex-direction: column; }
.details-header { padding: 20px; background: var(--bg-soft); border-bottom: 1px solid var(--border); position: sticky; top:0; z-index: 10; }
.details-body { padding: 20px; flex: 1; overflow-y: auto; }

/* Arch Details Cards */
.dep-card { 
    border: 1px solid var(--border); 
    border-radius: 8px; 
    margin-bottom: 12px; 
    padding: 12px; 
    transition: all 0.2s;
    position: relative;
}

/* INTERACTIVE (HAS TRACE) */
.dep-card.has-trace {
    background: rgba(255,255,255,0.03); 
    cursor: pointer;
}
.dep-card.has-trace:hover { 
    background: rgba(255,255,255,0.08); 
    transform: translateX(4px);
    border-color: var(--primary);
}
.dep-card.has-trace::after {
    content: '‚Ä∫';
    position: absolute;
    right: 15px; top: 50%;
    transform: translateY(-50%);
    font-size: 18px; color: var(--muted);
    opacity: 0; transition: opacity 0.2s;
}
.dep-card.has-trace:hover::after { opacity: 1; }

/* NON-INTERACTIVE (NO TRACE) */
.dep-card.no-trace {
    cursor: not-allowed;
    background: rgba(0, 0, 0, 0.2); /* Darker background */
    border-color: transparent;
    opacity: 0.7;
}
.dep-card.no-trace .dep-name { color: #6b7280; } /* Dimmed text */
.dep-card.no-trace .dep-ver { opacity: 0.5; }

.dep-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.dep-name { font-weight: 700; color: #e6e8f5; font-size: 13px; font-family: monospace; }
.dep-ver { color: #9ca3c9; font-size: 11px; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; }
.dep-meta { font-size: 11px; color: #6b7280; margin-top: 4px; display: flex; gap: 10px; }

/* Arch Zoom Controls */
.zoom-controls { position: absolute; bottom: 20px; left: 20px; display: flex; gap: 5px; z-index: 10; }
.zoom-btn { width: 32px; height: 32px; background: var(--panel); border: 1px solid var(--border); color: white; border-radius: 4px; cursor: pointer; display: grid; place-items: center; font-size: 16px; }
.zoom-btn:hover { background: var(--primary); border-color: var(--primary); }

.load-more-btn {
    width: 100%; padding: 10px;
    background: var(--bg-soft); border: 1px dashed var(--muted);
    color: var(--muted); cursor: pointer; border-radius: 8px;
    margin-top: 15px; font-size: 12px;
}
.load-more-btn:hover { border-color: var(--primary); color: var(--primary); background: rgba(99,102,241,0.05); }

/* --- TRACE MODAL STYLES --- */
.trace-modal {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 2100;
    justify-content: center; align-items: center;
    backdrop-filter: blur(5px);
    animation: fadeIn 0.2s ease;
}
.trace-content {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    width: 90%; max-width: 800px;
    height: 80vh;
    display: flex; flex-direction: column;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
}
.trace-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    background: var(--panel);
    border-radius: 12px 12px 0 0;
}
.trace-title { font-size: 16px; font-weight: 700; display:flex; gap:10px; align-items:center; }
.trace-body { flex: 1; overflow-y: auto; padding: 20px; }
.trace-item { margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 20px; }
.trace-item:last-child { border:none; margin-bottom:0; padding-bottom:0; }

.trace-file-path {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px; color: #d2a8ff;
    margin-bottom: 8px;
    display: flex; align-items: center; gap: 8px;
}
.trace-func-badge {
    background: #238636; color: white;
    padding: 2px 6px; border-radius: 4px;
    font-size: 10px; font-weight: 600;
}
.trace-code-block {
    background: #0d1117;
    border: 1px solid #30363d;
    border-radius: 6px;
    padding: 12px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    overflow-x: auto;
    color: #e6e8f5;
    position: relative;
    border-left: 3px solid var(--primary);
}
.line-num { color: #6e7681; margin-right: 12px; user-select: none; }
.code-text { color: #a5d6ff; }

</style>
</head>
<body>

<aside class="sidebar">
  <div class="logo">
    <div class="logo-icon">üõ°Ô∏è</div>
    <div class="logo-text">SecurityScan Hub</div>
  </div>
  <div class="nav-section">
    <h4>Navigation</h4>
    <a class="nav-item" href="tool-detail.html"><span>üìä</span><span>Overview</span></a>
    <a class="nav-item active" href="#" onclick="switchTab('vuln')"><span>‚ö†Ô∏è</span><span>Scan Results</span></a>
    <a class="nav-item" href="#" onclick="switchTab('arch')"><span>üèóÔ∏è</span><span>Architecture</span></a>
  </div>
  <div class="nav-section">
    <h4>Actions</h4>
    <a class="nav-item" href="index.html"><span>‚Üê</span><span>Back to Dashboard</span></a>
  </div>
</aside>

<main class="main-content">
  <div class="header-wrapper">
    <div class="header">
        <div class="breadcrumb">
            <a href="index.html">Home</a><span>/</span><span>Scan Results</span>
        </div>
        <div class="title-section">
            <div class="title-left">
                <h1><span style="font-size:32px">üõ°Ô∏è</span><span>Repository Analysis</span></h1>
                <div id="repoLabel" class="repo-label">Loading...</div>
            </div>
            <button class="btn" style="background:var(--primary); color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer" onclick="refreshAll()">Refresh Data</button>
        </div>
        <div class="meta-info">
            <div class="meta-item"><strong>Scanner:</strong> <span id="metaScanner">Loading...</span></div>
            <div class="meta-item"><strong>Generated At:</strong> <span id="metaDate">Loading...</span></div>
            <div class="meta-item"><strong>Source:</strong> <span id="metaSource">Loading...</span></div>
        </div>
    </div>

    <div class="tabs-container">
        <button class="tab-btn" id="btn-tab-arch" onclick="switchTab('arch')">
            <span>üèóÔ∏è</span> Architecture Map
        </button>
        <button class="tab-btn active" id="btn-tab-vuln" onclick="switchTab('vuln')">
            <span>üõ°Ô∏è</span> Vulnerabilities
        </button>
    </div>
  </div>

  <div id="view-vuln" class="view-panel active">
    <div class="scrollable-area">
        <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-num" id="totalVuln">-</div>
            <div class="stat-label">Total Vulnerabilities</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" style="color: var(--critical)" id="critCount">-</div>
            <div class="stat-label">Critical</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" style="color: var(--danger)" id="highCount">-</div>
            <div class="stat-label">High</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" style="color: var(--warning)" id="mediumCount">-</div>
            <div class="stat-label">Medium</div>
        </div>
        </div>

        <div class="table-container">
        <div class="table-header-control">
            <h2>Vulnerability List</h2>
            <input type="text" placeholder="Search..." onkeyup="filterTable(this.value)" style="background:var(--bg); border:1px solid var(--border); color:white; padding:8px 12px; border-radius:6px; min-width:250px;">
        </div>
        <table id="resultsTable">
            <thead>
            <tr>
                <th style="width: 30px"></th>
                <th>Component</th>
                <th>Ecosystem</th>
                <th>Severity / CVSS</th>
                <th>Vulnerability ID</th>
                <th>Proof of Concept</th>
                <th>Summary</th>
            </tr>
            </thead>
            <tbody id="tableBody">
            <tr><td colspan="7" style="text-align:center; padding: 40px; color: var(--muted)">Loading scan results...</td></tr>
            </tbody>
        </table>
        </div>
    </div>
  </div>

  <div id="view-arch" class="view-panel">
    <div style="flex:1; padding: 0 32px 32px 32px; overflow:hidden; display:flex;">
      <div class="arch-container" style="flex:1;">
          <div class="graph-pane" id="graph-pane">
              <div id="zoom-layer">
                  <div id="mermaid-output"></div>
              </div>
              <div class="zoom-controls">
                  <button class="zoom-btn" onclick="zoomIn()">+</button>
                  <button class="zoom-btn" onclick="zoomReset()">‚ü≤</button>
                  <button class="zoom-btn" onclick="zoomOut()">-</button>
              </div>
          </div>
          <div class="details-pane" id="details-pane">
              <div class="details-header">
                  <h3 id="detail-pane-title">Architecture Details</h3>
                  <div style="font-size:12px; color:var(--muted); margin-top:5px">Select a component to view dependencies</div>
              </div>
              <div class="details-body" id="detail-list-container">
                  <div style="text-align:center; color:#666; margin-top:50px">‚Üê Click a component in the graph</div>
              </div>
              <div style="padding: 10px 20px 20px 20px; display:none" id="load-more-container">
                  <button class="load-more-btn" onclick="loadMoreDependencies()">Load More Dependencies...</button>
              </div>
          </div>
      </div>
    </div>
  </div>

</main>

<div id="videoModal" class="video-modal" onclick="closeVideo()">
    <div class="video-content" onclick="event.stopPropagation()">
        <div class="video-header">
            <span class="video-title" id="videoTitle">Vulnerability PoC</span>
            <button class="close-video-btn" onclick="closeVideo()">‚úï</button>
        </div>
        <div class="media-viewport">
            <video id="pocVideoPlayer" controls>
                <source src="" type="video/mp4">
                Your browser does not support video.
            </video>
            <iframe id="pocIframe" src="" allowfullscreen></iframe>
        </div>
    </div>
</div>

<div id="traceModal" class="trace-modal" onclick="closeTraceModal()">
    <div class="trace-content" onclick="event.stopPropagation()">
        <div class="trace-header">
            <div class="trace-title">
                <span id="traceDepName">Dependency</span>
                <span style="font-weight:400; color:var(--muted); font-size:13px" id="traceDepVersion"></span>
            </div>
            <button class="close-video-btn" onclick="closeTraceModal()">‚úï</button>
        </div>
        <div class="trace-body" id="traceBody">
            </div>
    </div>
</div>

<script>
// --- GLOBAL CONFIGURATION ---
const API_BASE_URL = "https://llmscapi.wj2ai.com";
let currentRepoUrl = "";

// Architecture Pagination State
let currentActiveLayer = null;
let currentDepPage = 1;
const ITEMS_PER_PAGE = 20;

// Store fetched dependencies to enable clicking for trace details
window.currentLayerDeps = [];

// Initialize on Load
window.addEventListener('DOMContentLoaded', () => {
    // Get URL Parameter
    const params = new URLSearchParams(window.location.search);
    let url = params.get('url');
    // Fallback
    if (!url) url = sessionStorage.getItem('scanRepo') || "https://github.com/reworkd/AgentGPT";
    currentRepoUrl = url;
    
    // Update Header
    document.getElementById('repoLabel').textContent = currentRepoUrl;
    
    // Initial Fetch for Vulnerabilities
    fetchVulnData();
});

function refreshAll() {
    fetchVulnData();
    if(document.getElementById('view-arch').classList.contains('active')) {
        fetchArchitecture();
    }
}

// --- VIDEO MODAL LOGIC ---
window.openVideo = (cveId, pocUrl, event) => {
    if(event) event.stopPropagation();

    const modal = document.getElementById('videoModal');
    const videoPlayer = document.getElementById('pocVideoPlayer');
    const iframePlayer = document.getElementById('pocIframe');
    const title = document.getElementById('videoTitle');

    title.textContent = `Proof of Concept: ${cveId}`;
    modal.style.display = 'flex';

    let finalUrl = pocUrl;
    
    // Check if external (http/https)
    const isExternal = finalUrl.startsWith("http://") || finalUrl.startsWith("https://");
    
    if (isExternal) {
        // Use Iframe
        videoPlayer.style.display = 'none';
        iframePlayer.style.display = 'block';
        iframePlayer.src = finalUrl;
    } else {
        // Use Native Video Player
        iframePlayer.style.display = 'none';
        videoPlayer.style.display = 'block';
        
        // Add API Base if needed
        if (!finalUrl.startsWith("http")) {
            finalUrl = `${API_BASE_URL}${finalUrl.startsWith('/') ? '' : '/'}${finalUrl}`;
        }
        
        videoPlayer.src = finalUrl;
        videoPlayer.play().catch(e => console.log("Auto-play prevented:", e));
    }
};

window.closeVideo = () => {
    const modal = document.getElementById('videoModal');
    const videoPlayer = document.getElementById('pocVideoPlayer');
    const iframePlayer = document.getElementById('pocIframe');
    
    videoPlayer.pause();
    videoPlayer.src = "";
    iframePlayer.src = "";
    modal.style.display = 'none';
};


// --- TRACE MODAL LOGIC ---
window.openTraceModal = (depIndex) => {
    const dep = window.currentLayerDeps[depIndex];
    if (!dep) return;

    const modal = document.getElementById('traceModal');
    const titleName = document.getElementById('traceDepName');
    const titleVer = document.getElementById('traceDepVersion');
    const body = document.getElementById('traceBody');

    titleName.textContent = dep.name;
    titleVer.textContent = dep.version_constraints?.[0] || '';
    modal.style.display = 'flex';
    
    body.innerHTML = ''; // Clear previous

    if (!dep.used_in || dep.used_in.length === 0) {
        body.innerHTML = `<div style="text-align:center; color:var(--muted); padding:40px">
            <div style="font-size:24px; margin-bottom:10px">üîç</div>
            No explicit code usage traces found for this dependency.
        </div>`;
        return;
    }

    dep.used_in.forEach(trace => {
        const div = document.createElement('div');
        div.className = 'trace-item';
        div.innerHTML = `
            <div class="trace-file-path">
                <span>üìÑ ${trace.file}</span>
                ${trace.function ? `<span class="trace-func-badge">${trace.function}()</span>` : ''}
            </div>
            <div class="trace-code-block">
                <div><span class="line-num">${trace.call_line}</span><span class="code-text">${trace.call_expr}</span></div>
            </div>
        `;
        body.appendChild(div);
    });
};

window.closeTraceModal = () => {
    document.getElementById('traceModal').style.display = 'none';
};

document.addEventListener('keydown', (e) => {
    if (e.key === "Escape") {
        if(document.getElementById('videoModal').style.display === 'flex') closeVideo();
        if(document.getElementById('traceModal').style.display === 'flex') closeTraceModal();
    }
});


// --- TAB LOGIC ---
window.switchTab = (tabId) => {
    // UI Toggles
    document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    
    document.getElementById(`view-${tabId}`).classList.add('active');
    document.getElementById(`btn-tab-${tabId}`).classList.add('active');
    
    // Load Arch data if switching to it for the first time
    if (tabId === 'arch') {
        const output = document.getElementById('mermaid-output');
        if (!output.innerHTML) fetchArchitecture();
        setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
    }
};

// ==========================================
// PART 1: VULNERABILITY FUNCTIONS
// ==========================================
async function fetchVulnData() {
  try {
    const encodedUrl = encodeURIComponent(currentRepoUrl);
    const response = await fetch(`${API_BASE_URL}/api/results/potential?url=${encodedUrl}`);
    const result = await response.json();
    
    if (result.meta) {
        document.getElementById('metaScanner').textContent = result.meta.scanner || 'Unknown';
        document.getElementById('metaDate').textContent = new Date(result.meta.generated_at).toLocaleString() || 'N/A';
        document.getElementById('metaSource').textContent = result.meta.source || 'N/A';
    }

    const allData = result.data || [];
    renderTable(allData);
    updateStats(allData);
  } catch (error) {
    document.getElementById('tableBody').innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 40px; color: var(--danger)">Error loading data: ${error}</td></tr>`;
  }
}

function updateStats(data) {
  let crit = 0, high = 0, med = 0;
  data.forEach(item => {
    const s = (item.severity || "").toLowerCase();
    if (s === 'critical') crit++;
    else if (s === 'high') high++;
    else if (s === 'medium') med++;
  });
  
  document.getElementById('totalVuln').textContent = data.length;
  document.getElementById('critCount').textContent = crit;
  document.getElementById('highCount').textContent = high;
  document.getElementById('mediumCount').textContent = med;
}

function renderTable(data) {
  const tbody = document.getElementById('tableBody');
  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 40px">No vulnerabilities found!</td></tr>';
    return;
  }

  tbody.innerHTML = data.map((item, index) => {
    const severityClass = (item.severity || "none").toLowerCase();
    const severityLabel = (item.severity || "NONE").toUpperCase();
    const ecoBadge = (item.ecosystem || "").toLowerCase() === 'npm' ? 'npm' : 'pypi';
    const displaySummary = item.summary || '<span style="opacity:0.6; font-style:italic">No summary provided</span>';
    const lookupId = item.lookup_id || item.id; 

    // Checks for 'poc_video_url' string
    const pocUrl = item.poc_video_url;

    // Build Button
    const pocButton = pocUrl
        ? `<button class="poc-btn" onclick="openVideo('${item.id}', '${pocUrl}', event)"><span>‚ñ∂</span> Watch PoC</button>`
        : `<span style="opacity:0.3; font-size:12px; font-style:italic">‚Äî</span>`;

    return `
      <tr class="main-row" onclick="toggleRow(${index}, '${lookupId}')" id="row-${index}">
        <td><span class="chevron" id="chevron-${index}">‚ñº</span></td>
        <td>
          <div style="font-weight:600">${item.component || 'Unknown'}</div>
          <div style="color:var(--muted); font-size:12px">Used: ${item.version || 'N/A'}</div>
        </td>
        <td><span class="badge ${ecoBadge}">${item.ecosystem || 'Unknown'}</span></td>
        <td>
          <span class="severity ${severityClass}">${severityLabel}</span>
        </td>
        <td>
          <div id="vid-${index}" style="font-weight:600; font-family:monospace; color:var(--primary)">${item.id}</div>
        </td>
        <td>
            ${pocButton}
        </td>
        <td style="color:var(--muted); font-size:13px">${displaySummary}</td>
      </tr>
      <tr class="detail-row" id="detail-row-${index}">
        <td colspan="7">
          <div class="detail-content" id="detail-content-${index}"></div>
        </td>
      </tr>
    `;
  }).join('');
}

// Markdown Parser Helper
function parseMarkdown(text) {
    if (!text) return "";
    return text
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^## (.*$)/gim, '<h3>$1</h3>')
        .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
        .replace(/```([\s\S]*?)```/gim, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/gim, '<code>$1</code>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2" target="_blank">$1</a>')
        .replace(/\n/gim, '<br>');
}

// Toggle Row Details
async function toggleRow(index, cveId) {
    const mainRow = document.getElementById(`row-${index}`);
    const detailRow = document.getElementById(`detail-row-${index}`);
    const contentDiv = document.getElementById(`detail-content-${index}`);
    mainRow.classList.toggle('expanded');
    detailRow.classList.toggle('visible');
    
    if (detailRow.classList.contains('visible') && !contentDiv.hasAttribute('data-loaded')) {
        contentDiv.innerHTML = `<div style="text-align:center; padding:20px"><div class="loading-spinner"></div> Loading details...</div>`;
        try {
            const response = await fetch(`${API_BASE_URL}/api/cve/details?cve_id=${cveId}`);
            if (!response.ok) throw new Error('Not found');
            const data = await response.json();
            
            const summary = data.summary ? `<strong>${data.summary}</strong><br>` : "";
            const formattedDetails = parseMarkdown(data.details || "No detailed description available.");
            
            // Build Affected Packages HTML
            let affectedHTML = "";
            if (data.affected && data.affected.length > 0) {
                affectedHTML = data.affected.map(aff => {
                    const pkg = aff.package ? aff.package.name : "Unknown";
                    let rangesStr = (aff.ranges || []).map(r => {
                          const events = r.events.map(e => e.introduced ? `Intro: ${e.introduced}` : `Fixed: ${e.fixed}`).join(", ");
                          return `<div><small style="color:var(--muted)">${r.type}:</small> ${events}</div>`;
                    }).join("");
                    return `<div style="background:rgba(255,255,255,0.05); padding:8px; border-radius:4px; margin-bottom:8px"><strong>${pkg}</strong>${rangesStr}</div>`;
                }).join("");
            } else affectedHTML = "No affected version info.";

            const refsHTML = (data.references || []).map(ref => `<a href="${ref.url}" target="_blank">üîó ${ref.url}</a>`).join("");

            contentDiv.innerHTML = `
                <div style="border-left: 4px solid var(--primary); padding-left: 16px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start">
                        <h3 style="margin-bottom:12px; font-size:18px">${data.id}</h3>
                    </div>
                    <div class="md-content" style="margin-bottom:16px; font-size:14px; line-height:1.6">
                        ${summary} ${formattedDetails}
                    </div>
                    <div class="detail-grid">
                        <div class="detail-box">
                            <h4>Affected Packages</h4>
                            <div style="max-height:200px; overflow-y:auto; font-size:13px; color:var(--ink)">${affectedHTML}</div>
                        </div>
                        <div class="detail-box">
                            <h4>Metadata</h4>
                            <p><strong>Published:</strong> ${data.published || 'N/A'}</p>
                            <h4 style="margin-top:12px">References</h4>
                            <div class="detail-links" style="max-height:150px; overflow-y:auto">${refsHTML}</div>
                        </div>
                    </div>
                </div>
            `;
            contentDiv.setAttribute('data-loaded', 'true');
        } catch (err) { contentDiv.innerHTML = `<div style="color:var(--danger); padding:10px">Failed to load details.</div>`; }
    }
}

function filterTable(query) {
    const lowerQuery = query.toLowerCase();
    document.querySelectorAll('.main-row').forEach((row, index) => {
        const text = row.innerText.toLowerCase();
        const detailRow = document.getElementById(`detail-row-${index}`);
        if (text.includes(lowerQuery)) row.style.display = '';
        else {
            row.style.display = 'none';
            detailRow.classList.remove('visible');
            row.classList.remove('expanded');
        }
    });
}

// ==========================================
// PART 2: ARCHITECTURE FUNCTIONS
// ==========================================
async function fetchArchitecture() {
    const encodedUrl = encodeURIComponent(currentRepoUrl);
    const output = document.getElementById('mermaid-output');
    
    try {
        const response = await fetch(`${API_BASE_URL}/api/results/architecture?url=${encodedUrl}`);
        if (!response.ok) throw new Error("Architecture API failed");
        const json = await response.json();
        
        // 1. Build & Render Graph
        const mmd = buildMermaidSyntax(json);
        window.mermaid.initialize({ 
            startOnLoad: false, 
            theme: 'dark', 
            flowchart: { curve: 'basis' },
            securityLevel: 'loose' 
        });
        
        // Destructure bindFunctions from render result
        const { svg, bindFunctions } = await window.mermaid.render('graphDiv', mmd);
        output.innerHTML = svg;
        
        // IMPORTANT: Bind click events after inserting SVG
        if (bindFunctions) {
            bindFunctions(output);
        }
        
        // 2. Initialize Zoom & Pan
        setTimeout(zoomReset, 100);

    } catch (e) {
        console.error(e);
        output.innerHTML = `<div style="color:var(--danger); padding:20px">Failed to load architecture graph</div>`;
    }
}

function buildMermaidSyntax(data) {
    if (!data.diagram || !data.diagram.nodes) return 'graph TD\nError[Invalid Data]';
    let mmd = 'graph LR\n';
    
    // 1. Generate Subgraphs for Nodes
    data.diagram.nodes.forEach(node => {
        const layerId = node.id;
        const safeLayerId = layerId.replace(/-/g, '_');

        // Start Subgraph for the Layer
        mmd += `  subgraph ${safeLayerId} ["${node.label || node.id}"]\n`;
        mmd += `    direction TB\n`;

        // Render components inside
        if (node.components && node.components.length > 0) {
            node.components.forEach((comp, idx) => {
                const subNodeId = `${safeLayerId}_sub_${idx}`;
                const label = comp.replace(/"/g, "'");
                // Render node
                mmd += `    ${subNodeId}(["${label}"])\n`;
                // Style sub-node (darker background)
                mmd += `    style ${subNodeId} fill:#1f2937,stroke:#374151,color:#fff\n`;
                // Click event connects to the PARENT Layer ID
                mmd += `    click ${subNodeId} call onNodeClick("${layerId}")\n`;
            });
        } else {
            // Fallback if no components
            const fallbackId = `${safeLayerId}_main`;
            mmd += `    ${fallbackId}(["(No Components)"])\n`;
            mmd += `    click ${fallbackId} call onNodeClick("${layerId}")\n`;
        }

        mmd += `  end\n`; // End Subgraph

        // Style the Subgraph Border
        let stroke = "#30363d";
        if (layerId.toLowerCase().includes('user')) { stroke = "#3b82f6"; }
        else if (layerId.toLowerCase().includes('llm')) { stroke = "#ff5555"; }
        else if (layerId.toLowerCase().includes('orchestration')) { stroke = "#d29922"; }

        // Use standard styling for the subgraph container
        mmd += `  style ${safeLayerId} fill:#0d1117,stroke:${stroke},stroke-width:2px,color:#fff\n`;
    });
    
    // 2. Generate Edges (Connect Subgraphs)
    if (data.diagram.edges) {
        data.diagram.edges.forEach(edge => {
            const src = edge.from.replace(/-/g, '_');
            const dst = edge.to.replace(/-/g, '_');
            mmd += `  ${src} --> ${dst}\n`;
        });
    }
    return mmd;
}

// --- NODE CLICK HANDLER ---
window.onNodeClick = (layerId) => {
    // 1. Reset State
    currentActiveLayer = layerId;
    currentDepPage = 1;
    window.currentLayerDeps = []; // Reset stored dependencies
    
    // 2. Update Header
    document.getElementById('detail-pane-title').textContent = `Layer: ${layerId}`;
    
    // 3. Clear List
    const container = document.getElementById('detail-list-container');
    container.innerHTML = `<div style="text-align:center; padding:20px"><div class="loading-spinner"></div> Loading dependencies...</div>`;
    document.getElementById('load-more-container').style.display = 'none';

    // 4. Fetch First Page
    fetchLayerDependencies(layerId, 1);
};

// --- FETCH DEPENDENCIES (PAGINATED) ---
async function fetchLayerDependencies(layerId, page) {
    const encodedUrl = encodeURIComponent(currentRepoUrl);
    const encodedLayer = encodeURIComponent(layerId);
    
    try {
        const url = `${API_BASE_URL}/api/results/dependencies?url=${encodedUrl}&layer=${encodedLayer}&page=${page}&limit=${ITEMS_PER_PAGE}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error("Failed to fetch dependencies");
        
        const data = await response.json();
        
        // Store data globally for the trace modal
        if (page === 1) {
            window.currentLayerDeps = data.items;
        } else {
            window.currentLayerDeps = window.currentLayerDeps.concat(data.items);
        }
        
        renderDependencyList(data.items, page === 1, page);
        
        // Handle Load More Button Visibility
        const btnContainer = document.getElementById('load-more-container');
        if (data.has_more) {
            btnContainer.style.display = 'block';
        } else {
            btnContainer.style.display = 'none';
        }

    } catch (e) {
        console.error(e);
        const container = document.getElementById('detail-list-container');
        container.innerHTML = `<div style="color:var(--danger); padding:20px; text-align:center">Error loading dependencies.<br>${e.message}</div>`;
    }
}

function renderDependencyList(items, clearPrevious, page) {
    const container = document.getElementById('detail-list-container');
    
    if (clearPrevious) {
        container.innerHTML = "";
    }
    
    if (!items || items.length === 0) {
        if (clearPrevious) container.innerHTML = `<div style="text-align:center; color:var(--muted); padding:20px">No dependencies mapped to this layer.</div>`;
        return;
    }

    items.forEach((dep, index) => {
        // Calculate strict global index for the click handler
        const globalIndex = (page - 1) * ITEMS_PER_PAGE + index;
        
        const ecoClass = (dep.type || "unknown").toLowerCase();
        let reason = "Direct mapping";
        if (dep.architecture_mapping && dep.architecture_mapping.mapped_layers && dep.architecture_mapping.mapped_layers.length > 0) {
             reason = dep.architecture_mapping.mapped_layers[0].reason || reason;
        }

        // Determine if trace is available
        const hasTrace = dep.used_in && dep.used_in.length > 0;

        const card = document.createElement('div');
        
        // Apply classes conditionally
        if (hasTrace) {
            card.className = 'dep-card has-trace';
            card.setAttribute('onclick', `openTraceModal(${globalIndex})`);
        } else {
            card.className = 'dep-card no-trace';
        }
        
        card.innerHTML = `
            <div class="dep-header">
                <span class="dep-name">${dep.name}</span>
                <span class="dep-ver">${dep.version_constraints?.[0] || 'N/A'}</span>
            </div>
            <div style="font-size:12px; color:#c7cbe1; margin-bottom:6px">
                Type: <span style="color:var(--primary)">${ecoClass}</span>
            </div>
            <div class="dep-meta">
                <span>‚Ü≥ ${reason}</span>
            </div>
        `;
        container.appendChild(card);
    });
}

// --- LOAD MORE HANDLER ---
window.loadMoreDependencies = () => {
    if (!currentActiveLayer) return;
    currentDepPage += 1;
    fetchLayerDependencies(currentActiveLayer, currentDepPage);
}


// --- ARCHITECTURE ZOOM ---
let scale = 1, pX = 0, pY = 0;
const zoomLayer = document.getElementById('zoom-layer');
const pane = document.getElementById('graph-pane');
let isDrag = false, startX, startY;

function setTransform() { zoomLayer.style.transform = `translate(${pX}px, ${pY}px) scale(${scale})`; }
window.zoomIn = () => { scale *= 1.2; setTransform(); };
window.zoomOut = () => { scale /= 1.2; setTransform(); };
window.zoomReset = () => { scale = 0.9; pX = 0; pY = 0; setTransform(); };

pane.addEventListener('wheel', e => { e.preventDefault(); scale *= (e.deltaY > 0 ? 0.9 : 1.1); setTransform(); });
pane.addEventListener('mousedown', e => { 
    // Prevent drag if clicking a node (SVG element)
    if(e.target.closest('.node')) return; 
    
    isDrag = true; 
    startX = e.clientX - pX; 
    startY = e.clientY - pY; 
    pane.style.cursor = 'grabbing'; 
});
window.addEventListener('mousemove', e => { if(!isDrag)return; pX = e.clientX - startX; pY = e.clientY - startY; setTransform(); });
window.addEventListener('mouseup', () => { isDrag = false; pane.style.cursor = 'grab'; });

</script>
</body>
</html>

