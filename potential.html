<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SecurityScan Hub - Scan Results</title>
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    window.mermaid = mermaid;
</script>
<style>
/* --- ORIGINAL STYLES --- */
:root {
  --bg: #0a0b14;
  --bg-soft: #13151f;
  --panel: #1a1d2e;
  --ink: #e6e8f5;
  --muted: #9ca3c9;
  --border: #2a2d42;
  --primary: #6366f1;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #3b82f6;
  --critical: #d946ef;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--ink); display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; overflow: hidden; }

/* SIDEBAR */
.sidebar { background: var(--panel); border-right: 1px solid var(--border); padding: 24px; display: flex; flex-direction: column; height: 100vh; z-index: 10; }
.logo { display: flex; align-items: center; gap: 10px; margin-bottom: 32px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
.logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary), #8b5cf6); border-radius: 8px; display: grid; place-items: center; font-size: 18px; }
.logo-text { font-size: 16px; font-weight: 700; }
.nav-section { margin-bottom: 24px; }
.nav-section h4 { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); margin-bottom: 12px; font-weight: 600; }
.nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; color: var(--muted); text-decoration: none; font-size: 14px; transition: all 0.2s; cursor: pointer; }
.nav-item:hover, .nav-item.active { background: var(--bg-soft); color: var(--ink); }

/* MAIN LAYOUT */
.main-content { display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: relative; }

/* HEADER */
/* Fixed: Ensure header doesn't shrink */
.header-wrapper { flex-shrink: 0; padding: 32px 32px 0 32px; background: var(--bg); z-index: 5; }
.header { margin-bottom: 20px; }
.breadcrumb { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--muted); margin-bottom: 16px; }
.breadcrumb a { color: var(--primary); text-decoration: none; }
.title-section { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
.title-section h1 { font-size: 32px; display: flex; align-items: center; gap: 12px; }
.meta-info { display: flex; gap: 24px; flex-wrap: wrap; padding: 16px; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; font-size: 14px; }
.meta-item { display: flex; align-items: center; gap: 8px; }

/* TABS CONTROL */
.tabs-container {
    display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border);
}
.tab-btn {
    background: transparent; border: none; color: var(--muted);
    padding: 12px 20px; font-size: 14px; font-weight: 600; cursor: pointer;
    border-bottom: 3px solid transparent; transition: all 0.2s;
    display: flex; align-items: center; gap: 8px;
}
.tab-btn:hover { color: var(--ink); background: rgba(255,255,255,0.02); }
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: rgba(99, 102, 241, 0.05); }

/* CONTENT VIEWS & SCROLLING FIX */
.view-panel { 
    display: none; 
    flex-direction: column; 
    /* FIX: Removed height: 100% which caused overflow */
    flex: 1; 
    min-height: 0; /* Critical for nested flex scrolling */
    width: 100%;
}
.view-panel.active { display: flex; }

.scrollable-area { 
    flex: 1; 
    overflow-y: auto; 
    padding: 0 32px 32px 32px; /* moved padding here */
}

/* --- STATS & VULN TABLE STYLES --- */
.stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
.stat-card { background: var(--panel); border: 1px solid var(--border); padding: 24px; border-radius: 12px; text-align: center; }
.stat-num { font-size: 32px; font-weight: 800; margin-bottom: 4px; }
.stat-label { color: var(--muted); font-size: 14px; }

.table-container { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 40px; }
.table-header-control { padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
table { width: 100%; border-collapse: collapse; }
th { text-align: left; padding: 16px 24px; background: var(--bg-soft); color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; }
td { padding: 16px 24px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
tr.main-row { cursor: pointer; transition: background 0.2s; }
tr.main-row:hover { background: var(--bg-soft); }
tr.main-row.expanded { background: rgba(99, 102, 241, 0.05); border-left: 3px solid var(--primary); }
tr.detail-row { display: none; background: #13151f; }
tr.detail-row.visible { display: table-row; }
.detail-content { padding: 24px; animation: slideDown 0.3s ease; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

/* Severity Badges */
.severity { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; }
.severity.critical { background: rgba(217, 70, 239, 0.15); color: var(--critical); border: 1px solid var(--critical); }
.severity.high { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid var(--danger); }
.severity.medium { background: rgba(245, 158, 11, 0.15); color: var(--warning); border: 1px solid var(--warning); }
.severity.low { background: rgba(59, 130, 246, 0.15); color: var(--info); border: 1px solid var(--info); }
.severity.none { background: rgba(156, 163, 175, 0.15); color: var(--muted); border: 1px solid var(--muted); }
.badge.npm { background: rgba(203, 56, 55, 0.2); color: #cb3837; padding:2px 6px; border-radius:4px; font-size:11px; }
.badge.pypi { background: rgba(55, 117, 169, 0.2); color: #3775a9; padding:2px 6px; border-radius:4px; font-size:11px; }

/* Markdown & Detail Styles */
.detail-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 16px; }
.detail-box { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 16px; border: 1px solid rgba(255,255,255,0.05); }
.detail-links a { display: block; color: var(--primary); margin-bottom: 4px; font-size: 13px; text-decoration: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.md-content pre { background: #0d1117; padding: 10px; overflow-x: auto; border-radius: 4px; }
.chevron { transition: transform 0.3s; display: inline-block; }
.expanded .chevron { transform: rotate(180deg); }
.loading-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* --- ARCHITECTURE VIEW STYLES --- */
.arch-container { display: flex; height: 100%; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: #0d1117; }
.graph-pane { flex: 7; position: relative; border-right: 1px solid var(--border); overflow: hidden; cursor: grab; background: #0d1117; }
.graph-pane:active { cursor: grabbing; }
#zoom-layer { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; transform-origin: center center; transition: transform 0.1s ease-out; }
.details-pane { flex: 3; background: var(--panel); overflow-y: auto; padding: 20px; min-width: 300px; border-left: 1px solid var(--border); }

/* Arch Details */
.layer-card { background: var(--bg-soft); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px; }
.card-header { padding: 10px; background: #21262d; border-bottom: 1px solid var(--border); font-weight: 700; font-size: 13px; color: white; display: flex; justify-content: space-between; }
.card-body { padding: 12px; }
.tag { display: inline-block; background: #238636; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin: 0 4px 4px 0; border: 1px solid rgba(255,255,255,0.1); }
.file-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #2a2d42; font-family: monospace; font-size: 11px; color: #8b949e; }
.file-path { color: #d2a8ff; margin-right: 8px; word-break: break-all; }
.file-lines { color: #79c0ff; white-space: nowrap; }

/* Arch Zoom Controls */
.zoom-controls { position: absolute; bottom: 20px; left: 20px; display: flex; gap: 5px; z-index: 10; }
.zoom-btn { width: 32px; height: 32px; background: var(--panel); border: 1px solid var(--border); color: white; border-radius: 4px; cursor: pointer; display: grid; place-items: center; font-size: 16px; }
.zoom-btn:hover { background: var(--primary); border-color: var(--primary); }

</style>
</head>
<body>

<aside class="sidebar">
  <div class="logo">
    <div class="logo-icon">üõ°Ô∏è</div>
    <div class="logo-text">SecurityScan Hub</div>
  </div>
  <div class="nav-section">
    <h4>Navigation</h4>
    <a class="nav-item" href="tool-detail.html"><span>üìä</span><span>Overview</span></a>
    <a class="nav-item active" href="#" onclick="switchTab('vuln')"><span>‚ö†Ô∏è</span><span>Scan Results</span></a>
    <a class="nav-item" href="#" onclick="switchTab('arch')"><span>üèóÔ∏è</span><span>Architecture</span></a>
  </div>
  <div class="nav-section">
    <h4>Actions</h4>
    <a class="nav-item" href="index.html"><span>‚Üê</span><span>Back to Dashboard</span></a>
  </div>
</aside>

<main class="main-content">
  <div class="header-wrapper">
    <div class="header">
        <div class="breadcrumb">
            <a href="index.html">Home</a><span>/</span><span>Scan Results</span>
        </div>
        <div class="title-section">
            <h1><span style="font-size:32px">üõ°Ô∏è</span><span>Repository Analysis</span></h1>
            <button class="btn" style="background:var(--primary); color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer" onclick="refreshAll()">Refresh Data</button>
        </div>
        <div class="meta-info">
            <div class="meta-item"><strong>Scanner:</strong> <span id="metaScanner">Loading...</span></div>
            <div class="meta-item"><strong>Generated At:</strong> <span id="metaDate">Loading...</span></div>
            <div class="meta-item"><strong>Source:</strong> <span id="metaSource">Loading...</span></div>
        </div>
    </div>

    <div class="tabs-container">
        <button class="tab-btn active" id="btn-tab-vuln" onclick="switchTab('vuln')">
            <span>üõ°Ô∏è</span> Vulnerabilities
        </button>
        <button class="tab-btn" id="btn-tab-arch" onclick="switchTab('arch')">
            <span>üèóÔ∏è</span> Architecture Map
        </button>
    </div>
  </div>

  <div id="view-vuln" class="view-panel active">
    <div class="scrollable-area">
        <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-num" id="totalVuln">-</div>
            <div class="stat-label">Total Vulnerabilities</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" style="color: var(--critical)" id="critCount">-</div>
            <div class="stat-label">Critical</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" style="color: var(--danger)" id="highCount">-</div>
            <div class="stat-label">High</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" style="color: var(--warning)" id="mediumCount">-</div>
            <div class="stat-label">Medium</div>
        </div>
        </div>

        <div class="table-container">
        <div class="table-header-control">
            <h2>Vulnerability List</h2>
            <input type="text" placeholder="Search..." onkeyup="filterTable(this.value)" style="background:var(--bg); border:1px solid var(--border); color:white; padding:8px 12px; border-radius:6px; min-width:250px;">
        </div>
        <table id="resultsTable">
            <thead>
            <tr>
                <th style="width: 30px"></th>
                <th>Component</th>
                <th>Ecosystem</th>
                <th>Severity / CVSS</th>
                <th>Vulnerability ID</th>
                <th>Summary</th>
            </tr>
            </thead>
            <tbody id="tableBody">
            <tr><td colspan="6" style="text-align:center; padding: 40px; color: var(--muted)">Loading scan results...</td></tr>
            </tbody>
        </table>
        </div>
    </div>
  </div>

  <div id="view-arch" class="view-panel">
    <div style="flex:1; padding: 0 32px 32px 32px; overflow:hidden; display:flex;">
      <div class="arch-container" style="flex:1;">
          <div class="graph-pane" id="graph-pane">
              <div id="zoom-layer">
                  <div id="mermaid-output"></div>
              </div>
              <div class="zoom-controls">
                  <button class="zoom-btn" onclick="zoomIn()">+</button>
                  <button class="zoom-btn" onclick="zoomReset()">‚ü≤</button>
                  <button class="zoom-btn" onclick="zoomOut()">-</button>
              </div>
          </div>
          <div class="details-pane" id="details-pane">
              <div style="text-align:center; color:#666; margin-top:50px">Loading architecture data...</div>
          </div>
      </div>
    </div>
  </div>

</main>

<script>
// --- GLOBAL CONFIGURATION ---
const API_BASE_URL = "https://llmscapi.wj2ai.com";
let currentRepoUrl = "";

// Initialize on Load
window.addEventListener('DOMContentLoaded', () => {
    // Get URL Parameter
    const params = new URLSearchParams(window.location.search);
    let url = params.get('url');
    // Fallback
    if (!url) url = sessionStorage.getItem('scanRepo') || "https://github.com/reworkd/AgentGPT";
    currentRepoUrl = url;
    
    // Initial Fetch for Vulnerabilities
    fetchVulnData();
});

function refreshAll() {
    fetchVulnData();
    if(document.getElementById('view-arch').classList.contains('active')) {
        fetchArchitecture();
    }
}

// --- TAB LOGIC ---
window.switchTab = (tabId) => {
    // UI Toggles
    document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    
    document.getElementById(`view-${tabId}`).classList.add('active');
    document.getElementById(`btn-tab-${tabId}`).classList.add('active');
    
    // Load Arch data if switching to it for the first time
    if (tabId === 'arch') {
        const output = document.getElementById('mermaid-output');
        if (!output.innerHTML) fetchArchitecture();
        // Resize check for mermaid
        setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
    }
};

// ==========================================
// PART 1: VULNERABILITY FUNCTIONS (Original)
// ==========================================
async function fetchVulnData() {
  try {
    const encodedUrl = encodeURIComponent(currentRepoUrl);
    const response = await fetch(`${API_BASE_URL}/api/results/potential?url=${encodedUrl}`);
    const result = await response.json();
    
    if (result.meta) {
        document.getElementById('metaScanner').textContent = result.meta.scanner || 'Unknown';
        document.getElementById('metaDate').textContent = new Date(result.meta.generated_at).toLocaleString() || 'N/A';
        document.getElementById('metaSource').textContent = result.meta.source || 'N/A';
    }

    const allData = result.data || [];
    renderTable(allData);
    updateStats(allData);
  } catch (error) {
    document.getElementById('tableBody').innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 40px; color: var(--danger)">Error loading data: ${error}</td></tr>`;
  }
}

function updateStats(data) {
  let crit = 0, high = 0, med = 0;
  data.forEach(item => {
    const s = (item.severity || "").toLowerCase();
    if (s === 'critical') crit++;
    else if (s === 'high') high++;
    else if (s === 'medium') med++;
  });
  
  document.getElementById('totalVuln').textContent = data.length;
  document.getElementById('critCount').textContent = crit;
  document.getElementById('highCount').textContent = high;
  document.getElementById('mediumCount').textContent = med;
}

function renderTable(data) {
  const tbody = document.getElementById('tableBody');
  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 40px">No vulnerabilities found!</td></tr>';
    return;
  }

  tbody.innerHTML = data.map((item, index) => {
    const severityClass = (item.severity || "none").toLowerCase();
    const severityLabel = (item.severity || "NONE").toUpperCase();
    const ecoBadge = (item.ecosystem || "").toLowerCase() === 'npm' ? 'npm' : 'pypi';
    const displaySummary = item.summary || '<span style="opacity:0.6; font-style:italic">No summary provided</span>';
    const lookupId = item.lookup_id || item.id; 

    return `
      <tr class="main-row" onclick="toggleRow(${index}, '${lookupId}')" id="row-${index}">
        <td><span class="chevron" id="chevron-${index}">‚ñº</span></td>
        <td>
          <div style="font-weight:600">${item.component || 'Unknown'}</div>
          <div style="color:var(--muted); font-size:12px">Used: ${item.version || 'N/A'}</div>
        </td>
        <td><span class="badge ${ecoBadge}">${item.ecosystem || 'Unknown'}</span></td>
        <td>
          <span class="severity ${severityClass}">${severityLabel}</span>
        </td>
        <td>
          <div id="vid-${index}" style="font-weight:600; font-family:monospace; color:var(--primary)">${item.id}</div>
        </td>
        <td style="color:var(--muted); font-size:13px">${displaySummary}</td>
      </tr>
      <tr class="detail-row" id="detail-row-${index}">
        <td colspan="6">
          <div class="detail-content" id="detail-content-${index}"></div>
        </td>
      </tr>
    `;
  }).join('');
}

// Markdown Parser Helper
function parseMarkdown(text) {
    if (!text) return "";
    return text
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^## (.*$)/gim, '<h3>$1</h3>')
        .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
        .replace(/```([\s\S]*?)```/gim, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/gim, '<code>$1</code>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2" target="_blank">$1</a>')
        .replace(/\n/gim, '<br>');
}

// Toggle Row Details
async function toggleRow(index, cveId) {
    const mainRow = document.getElementById(`row-${index}`);
    const detailRow = document.getElementById(`detail-row-${index}`);
    const contentDiv = document.getElementById(`detail-content-${index}`);
    mainRow.classList.toggle('expanded');
    detailRow.classList.toggle('visible');
    
    if (detailRow.classList.contains('visible') && !contentDiv.hasAttribute('data-loaded')) {
        contentDiv.innerHTML = `<div style="text-align:center; padding:20px"><div class="loading-spinner"></div> Loading details...</div>`;
        try {
            const response = await fetch(`${API_BASE_URL}/api/cve/details?cve_id=${cveId}`);
            if (!response.ok) throw new Error('Not found');
            const data = await response.json();
            
            const summary = data.summary ? `<strong>${data.summary}</strong><br>` : "";
            const formattedDetails = parseMarkdown(data.details || "No detailed description available.");
            
            // Build Affected Packages HTML
            let affectedHTML = "";
            if (data.affected && data.affected.length > 0) {
                affectedHTML = data.affected.map(aff => {
                    const pkg = aff.package ? aff.package.name : "Unknown";
                    let rangesStr = (aff.ranges || []).map(r => {
                         const events = r.events.map(e => e.introduced ? `Intro: ${e.introduced}` : `Fixed: ${e.fixed}`).join(", ");
                         return `<div><small style="color:var(--muted)">${r.type}:</small> ${events}</div>`;
                    }).join("");
                    return `<div style="background:rgba(255,255,255,0.05); padding:8px; border-radius:4px; margin-bottom:8px"><strong>${pkg}</strong>${rangesStr}</div>`;
                }).join("");
            } else affectedHTML = "No affected version info.";

            // Build References
            const refsHTML = (data.references || []).map(ref => `<a href="${ref.url}" target="_blank">üîó ${ref.url}</a>`).join("");

            contentDiv.innerHTML = `
                <div style="border-left: 4px solid var(--primary); padding-left: 16px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start">
                        <h3 style="margin-bottom:12px; font-size:18px">${data.id}</h3>
                    </div>
                    <div class="md-content" style="margin-bottom:16px; font-size:14px; line-height:1.6">
                        ${summary} ${formattedDetails}
                    </div>
                    <div class="detail-grid">
                        <div class="detail-box">
                            <h4>Affected Packages</h4>
                            <div style="max-height:200px; overflow-y:auto; font-size:13px; color:var(--ink)">${affectedHTML}</div>
                        </div>
                        <div class="detail-box">
                            <h4>Metadata</h4>
                            <p><strong>Published:</strong> ${data.published || 'N/A'}</p>
                            <h4 style="margin-top:12px">References</h4>
                            <div class="detail-links" style="max-height:150px; overflow-y:auto">${refsHTML}</div>
                        </div>
                    </div>
                </div>
            `;
            contentDiv.setAttribute('data-loaded', 'true');
        } catch (err) { contentDiv.innerHTML = `<div style="color:var(--danger); padding:10px">Failed to load details.</div>`; }
    }
}

function filterTable(query) {
    const lowerQuery = query.toLowerCase();
    document.querySelectorAll('.main-row').forEach((row, index) => {
        const text = row.innerText.toLowerCase();
        const detailRow = document.getElementById(`detail-row-${index}`);
        if (text.includes(lowerQuery)) row.style.display = '';
        else {
            row.style.display = 'none';
            detailRow.classList.remove('visible');
            row.classList.remove('expanded');
        }
    });
}

// ==========================================
// PART 2: ARCHITECTURE FUNCTIONS (New)
// ==========================================
async function fetchArchitecture() {
    const encodedUrl = encodeURIComponent(currentRepoUrl);
    const output = document.getElementById('mermaid-output');
    const details = document.getElementById('details-pane');
    
    try {
        const response = await fetch(`${API_BASE_URL}/api/results/architecture?url=${encodedUrl}`);
        if (!response.ok) throw new Error("Architecture API failed");
        const json = await response.json();
        
        // 1. Render Graph
        const mmd = buildMermaidSyntax(json);
        window.mermaid.initialize({ startOnLoad: false, theme: 'dark', flowchart: { curve: 'basis' } });
        const { svg } = await window.mermaid.render('graphDiv', mmd);
        output.innerHTML = svg;
        
        // 2. Render Details Side Panel
        renderArchDetails(json);
        
        // 3. Reset Zoom
        setTimeout(zoomReset, 100);
        
    } catch (e) {
        console.error(e);
        output.innerHTML = `<div style="color:var(--danger); padding:20px">Failed to load architecture graph</div>`;
        details.innerHTML = `<div style="color:#666; text-align:center; margin-top:50px">No data available</div>`;
    }
}

function buildMermaidSyntax(data) {
    if (!data.diagram || !data.diagram.nodes) return 'graph TD\nError[Invalid Data]';
    let mmd = 'graph LR\n';
    
    // Draw Nodes
    data.diagram.nodes.forEach(node => {
        const safeId = node.id.replace(/-/g, '_'); 
        const label = node.label || node.id;
        mmd += `  ${safeId}(["${label}"])\n`;
        
        let fill = "#161b22"; let stroke = "#30363d";
        if (node.id.toLowerCase().includes('user')) { fill = "#1f2937"; stroke = "#3b82f6"; }
        else if (node.id.toLowerCase().includes('llm')) { fill = "#360412"; stroke = "#ff5555"; }
        else if (node.id.toLowerCase().includes('orchestration')) { fill = "#362800"; stroke = "#d29922"; }
        
        mmd += `  style ${safeId} fill:${fill},stroke:${stroke},color:#fff\n`;
    });
    
    // Draw Edges
    if (data.diagram.edges) {
        data.diagram.edges.forEach(edge => {
            const src = edge.from.replace(/-/g, '_');
            const dst = edge.to.replace(/-/g, '_');
            mmd += `  ${src} --> ${dst}\n`;
        });
    }
    return mmd;
}

function renderArchDetails(data) {
    const pane = document.getElementById('details-pane');
    pane.innerHTML = "";
    
    const layers = data.layers || {};
    const order = data.diagram && data.diagram.nodes ? data.diagram.nodes.map(n => n.id) : Object.keys(layers);
    
    order.forEach(layerId => {
        const layer = layers[layerId];
        if (!layer || layer.exists === false) return;
        
        const files = layer.files || [];
        const topFiles = files.slice(0, 8);
        const remaining = files.length - 8;
        
        let fileListHtml = "";
        if (files.length > 0) {
            fileListHtml = `<ul class="file-list">` + topFiles.map(f => {
                const parts = f.split(':');
                const line = parts.length > 1 ? parts.pop() : '';
                const path = parts.join(':');
                return `<li class="file-item"><span class="file-path">${path}</span><span class="file-lines">${line}</span></li>`;
            }).join('') + `</ul>`;
            if (remaining > 0) fileListHtml += `<div style="text-align:center; font-size:10px; color:var(--primary); margin-top:5px">+ ${remaining} more files</div>`;
        } else {
            fileListHtml = `<div style="font-style:italic; font-size:11px; color:#555">No specific files mapped</div>`;
        }
        
        const comps = layer.components ? layer.components.map(c => `<span class="tag">${c}</span>`).join('') : '';

        const card = document.createElement('div');
        card.className = 'layer-card';
        card.innerHTML = `
            <div class="card-header">
                <span>${layerId}</span>
                <span style="font-weight:400; color:#888; font-size:11px">${files.length} Files</span>
            </div>
            <div class="card-body">
                <div style="margin-bottom:10px">${comps}</div>
                ${fileListHtml}
            </div>
        `;
        pane.appendChild(card);
    });
}

// --- ARCHITECTURE ZOOM ---
let scale = 1, pX = 0, pY = 0;
const zoomLayer = document.getElementById('zoom-layer');
const pane = document.getElementById('graph-pane');
let isDrag = false, startX, startY;

function setTransform() { zoomLayer.style.transform = `translate(${pX}px, ${pY}px) scale(${scale})`; }
window.zoomIn = () => { scale *= 1.2; setTransform(); };
window.zoomOut = () => { scale /= 1.2; setTransform(); };
window.zoomReset = () => { scale = 0.9; pX = 0; pY = 0; setTransform(); };

pane.addEventListener('wheel', e => { e.preventDefault(); scale *= (e.deltaY > 0 ? 0.9 : 1.1); setTransform(); });
pane.addEventListener('mousedown', e => { isDrag = true; startX = e.clientX - pX; startY = e.clientY - pY; pane.style.cursor = 'grabbing'; });
window.addEventListener('mousemove', e => { if(!isDrag)return; pX = e.clientX - startX; pY = e.clientY - startY; setTransform(); });
window.addEventListener('mouseup', () => { isDrag = false; pane.style.cursor = 'grab'; });

</script>
</body>
</html>

